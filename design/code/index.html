



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Implementation details - Customer analysis with cognitive and analytics in hybrid cloud</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#implementation-details" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Customer analysis with cognitive and analytics in hybrid cloud" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Customer analysis with cognitive and analytics in hybrid cloud
            </span>
            <span class="md-header-nav__topic">
              Implementation details
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-cognitive-analytics/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Customer analysis with cognitive and analytics in hybrid cloud" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Customer analysis with cognitive and analytics in hybrid cloud
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-cognitive-analytics/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Welcome" class="md-nav__link">
      Welcome
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../method/readme/" title="Methodology" class="md-nav__link">
      Methodology
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Business Problem
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Business Problem
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../businessproblem/" title="Presentation" class="md-nav__link">
      Presentation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../flow/" title="Demonstration" class="md-nav__link">
      Demonstration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Design
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Design
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../readme/" title="Design considerations" class="md-nav__link">
      Design considerations
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Implementation details
      </label>
    
    <a href="./" title="Implementation details" class="md-nav__link md-nav__link--active">
      Implementation details
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#web-application" title="Web Application" class="md-nav__link">
    Web Application
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#code-explanation" title="Code explanation" class="md-nav__link">
    Code explanation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#angular-app" title="Angular app" class="md-nav__link">
    Angular app
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-components" title="Main Components" class="md-nav__link">
    Main Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#home-page" title="Home page" class="md-nav__link">
    Home page
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conversation-bot" title="Conversation bot" class="md-nav__link">
    Conversation bot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-component" title="Account component" class="md-nav__link">
    Account component
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-code" title="Server code" class="md-nav__link">
    Server code
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conversation-back-end" title="Conversation back end" class="md-nav__link">
    Conversation back end
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customer-back-end" title="Customer back end" class="md-nav__link">
    Customer back end
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#churn-risk-scoring" title="Churn risk scoring" class="md-nav__link">
    Churn risk scoring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helm-chart" title="Helm chart" class="md-nav__link">
    Helm chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#icp-deployment" title="ICP deployment" class="md-nav__link">
    ICP deployment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customer-microservice" title="Customer Microservice" class="md-nav__link">
    Customer Microservice
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-readings" title="More readings" class="md-nav__link">
    More readings
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../run/" title="Deployments" class="md-nav__link">
      Deployments
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#web-application" title="Web Application" class="md-nav__link">
    Web Application
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#code-explanation" title="Code explanation" class="md-nav__link">
    Code explanation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#angular-app" title="Angular app" class="md-nav__link">
    Angular app
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-components" title="Main Components" class="md-nav__link">
    Main Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#home-page" title="Home page" class="md-nav__link">
    Home page
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conversation-bot" title="Conversation bot" class="md-nav__link">
    Conversation bot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-component" title="Account component" class="md-nav__link">
    Account component
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-code" title="Server code" class="md-nav__link">
    Server code
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conversation-back-end" title="Conversation back end" class="md-nav__link">
    Conversation back end
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customer-back-end" title="Customer back end" class="md-nav__link">
    Customer back end
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#churn-risk-scoring" title="Churn risk scoring" class="md-nav__link">
    Churn risk scoring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helm-chart" title="Helm chart" class="md-nav__link">
    Helm chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#icp-deployment" title="ICP deployment" class="md-nav__link">
    ICP deployment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customer-microservice" title="Customer Microservice" class="md-nav__link">
    Customer Microservice
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#more-readings" title="More readings" class="md-nav__link">
    More readings
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-cognitive-analytics/edit/master/docs/design/code.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="implementation-details">Implementation details</h1>
<p>In this chapter we are addressing the Angular 5 implementation and the Backend For Frontend as a nodejs app used to implement authentication, service orchestration, data mapping and to serve the Angular App. The BFF is also using Hystrix JS for circuit breaker and fault tolerance.</p>
<p>Update 08/2108 - Author <a href="https://www.linkedin.com/in/jeromeboyer/">Jerome Boyer</a></p>
<h2 id="web-application">Web Application</h2>
<h3 id="code-explanation">Code explanation</h3>
<p>Most of the end user's interactions are supported by <a href="http://angular.io">Angular 5 single page</a> javascript library, with its <code>router</code> mechanism and the DOM rendering capabilities via directives and components. When there is a need to access data to the on-premise server for persistence, an AJAX call is done to server, and  the server will respond asynchronously later on. The components involved are presented in the figure below in a generic way:</p>
<p><img alt="Angular 5 App" src="../ang-node-comp.png" /></p>
<p>From an implementation point of view we are interested by the router, the controller and the services.</p>
<p>To clearly separate the codebase for front-end and back-end the <code>src/client</code> folder includes Angular 5 code while <code>src/server</code> folder includes the REST api and BFF implemented with expressjs.</p>
<h2 id="angular-app">Angular app</h2>
<p>The application code follows the standard best practices for Angularjs development:
<em> unique index.html to support single page application
</em> use of modules to organize features
<em> use of component, html and css per feature page
</em> encapsulate calls to back end for front end server via service components.</p>
<p>We recommend Angular beginners to follow the <a href="https://angular.io/tutorial">product "tour of heroes" tutorial</a>. We also recommend to read our last work on Angular 5 app using a test driven development approach in <a href="https://github.com/ibm-cloud-architecture/refarch-caseportal-app">this project</a>.</p>
<h3 id="main-components">Main Components</h3>
<p>As traditional Angular 5 app, you need:
<em>  a <code>main.ts</code> script to declare and bootstrap your application.
</em> a <code>app.module.ts</code> to declare all the components of the application and the URL routes declaration. Those routes are internal to the web browser. They are protected by a guard mechanism to avoid unlogged person to access some private pages. The following code declares four routes for the four main features of this application: display the main top navigation page, the customer page to access account, and the itSupport to access the chat bot user interface. The AuthGard component assesses if the user is known and logged, if not he/she is routed to the login page.
 <code>const routes: Routes = [
   { path: 'home', component: HomeComponent,canActivate: [AuthGuard]},
   { path: 'log', component: LoginComponent },
   //canActivate: [AuthGuard]
   { path: 'itSupport', component: ConversationComponent,canActivate: [AuthGuard]},
   { path: 'customer', component: CustomersComponent,canActivate: [AuthGuard]},
   // otherwise redirect to home
   { path: '**', redirectTo: 'home' }
 ]</code>
* an <code>app.component</code> to support the main page template where routing is done. This component has the header and footer of the HTML page and the placeholder directly to support sub page routing:
 <code>&lt;router-outlet&gt;&lt;/router-outlet&gt;</code></p>
<h3 id="home-page">Home page</h3>
<p>The home page is just a front end to navigate to the different features. It persists the user information in a local storage and uses the Angular router capability to map widget button action to method and route.
For example the following HTML page uses angular construct to link the button to the <code>itSupport()</code> method of the Home.component.ts</p>
<pre><code class="html">&lt;div class=&quot;col-md-6 roundRect&quot; style=&quot;box-shadow: 3px 3px 1px #05870b; border-color: #05870b;&quot;&gt;
      &lt;h2&gt;Support Help&lt;/h2&gt;
      &lt;p&gt;Get help&lt;/p&gt;
      &lt;p&gt;&lt;button (click)=&quot;itSupport()&quot; class=&quot;btn btn-primary&quot;&gt;Ask me&lt;/button&gt;&lt;/p&gt;
&lt;/div&gt;
</code></pre>

<p>the method delegates to the angular router with the 'itSupport' url</p>
<pre><code class="javascript">itSupport(){
  this.router.navigate(['itSupport']);
}
</code></pre>

<h3 id="conversation-bot">Conversation bot</h3>
<p>For the conversation front end we are re-using the code approach of the conversation broker of the <a href="https://github.com/ibm-cloud-architecture/refarch-cognitive-conversation-broker">Cognitive reference architecture implementation</a>.
The same approach, service and component are used to control the user interface and to call the back end. The service does an HTTP POST of the newly entered message:</p>
<pre><code>export class ConversationService {
  private convUrl ='/api/c/conversation/';

  constructor(private http: Http) {
  };

  submitMessage(msg:string,ctx:any): Observable&lt;any&gt;{
    let user = JSON.parse(sessionStorage.getItem('currentUser'));
    let bodyString = JSON.stringify(  { text:msg,context:ctx,user:user });

    let headers = new Headers({ 'Content-Type': 'application/json' });
    let options = new RequestOptions({ headers: headers })
    return this.http.post(this.convUrl,bodyString,options)
         .map((res:Response) =&gt; res.json())
  }
}
</code></pre>

<p>So it is interesting to see the message as the watson conversation context and the user basic information.</p>
<h3 id="account-component">Account component</h3>
<p>When the user selects to access the account information, the routing is going to the account component in <code>client/app/account</code> folder use a service to call the nodejs / expressjs REST services as illustrated in the code below:  </p>
<pre><code class="javascript">export class CustomerService {
  private invUrl ='/api/c';

  constructor(private http: Http) {
  };

  getItems(): Observable&lt;any&gt;{
    return this.http.get(this.invUrl+'/customer')
         .map((res:Response) =&gt; res.json())
  }
}
</code></pre>

<p>The http component is injected at service creation, and the promise returned object is map so the response can be processed as json document.</p>
<p>An example of code using those service is the <code>account.component.ts</code>, which loads the account during component initialization phase.</p>
<pre><code class="javascript">export class AccountComponent implements OnInit {

  constructor(private router: Router, private cService : CustomerService){
  }

  // Uses in init to load data and not the constructor.
  ngOnInit(): void {
    this.user = JSON.parse(localStorage.getItem('currentUser'));
    if(this.user &amp;&amp; 'email' in this.user) {
      cService.getCustomerByEmail(this.user.email).subscribe(
          data =&gt; {
            this.customer=data;
          },
          error =&gt; {
            console.log(error);
          });
    }
  }
}
</code></pre>

<h2 id="server-code">Server code</h2>
<p>The application is using nodejs and expressjs standard code structure. The code is under <code>server</code> folder.</p>
<h3 id="conversation-back-end">Conversation back end</h3>
<p>The script is in <code>server/route/features/chatBot.js</code> and uses the Watson developer cloud library to connect to the remote service. This library encapsulates HTTP calls and simplifies the interactions with the public service. The only thing that needs to be done for each chat bot is to add the logic to process the response, for example to get data from a backend, presents user choices in a form of buttons, or call remote service like a rule engine / decision service.</p>
<p>This module exports one function to be called by the API used by the front end. This API is defined in <code>api.js</code> as:</p>
<pre><code class="javascript">app.post('/api/c/conversation',isLoggedIn,(req,res) =&gt; {
  chatBot.chat(config,req,res)
});
</code></pre>

<p>The <code>chatBot.chat()</code> method gets the message and connection parameters and uses the Watson API to transfer the call. The set of if statements are used to perform actions, call services, using the variables set in the Watson Conversation Context. One example is to use the Operational Decision Management rule engine to compute the best product for a given customer situation.</p>
<pre><code class="javascript">chat : function(config,req,res){
  req.body.context.predefinedResponses=&quot;&quot;;
  console.log(&quot;text &quot;+req.body.text+&quot;.&quot;)
  if (req.body.context.toneAnalyzer &amp;&amp; req.body.text !== &quot;&quot; ) {
      analyzeTone(config,req,res)
  }
  if (req.body.context.action === &quot;search&quot; &amp;&amp; req.body.context.item ===&quot;UserRequests&quot;) {
      getSupportTicket(config,req,res);
  }
  if (req.body.context.action === &quot;recommend&quot;) {
      odmclient.recommend(config,req.body.context,res, function(contextWithRecommendation){
        req.body.context = contextWithRecommendation;
        sendToWCSAndBackToUser(config,req,res);
      });
  }
  if (req.body.context.action === &quot;transfer&quot;) {
      console.log(&quot;Transfer to &quot;+ req.body.context.item)
  }

  if (req.body.context.action === undefined) {
      sendToWCSAndBackToUser(config,req,res);
  }
} // chat
</code></pre>

<p>The send message uses the Watson developer library:</p>
<pre><code class="javascript">
  conversation = watson.conversation({
          username: config.conversation.username,
          password: config.conversation.password,
          version: config.conversation.version,
          version_date: config.conversation.versionDate});

  conversation.message(
      {
      workspace_id: wkid,
      input: {'text': message.text},
      context: message.context
      },
      function(err, response) {
        // add logic here to process the conversation response
      }
    )
</code></pre>

<p>It uses content of the conversation context to drive some of the routing mechanism. This code supports the following sequencing:</p>
<p><img alt="" src="../seq-diagram.png" /></p>
<ul>
<li>
<p>As the user is enquiring about an existing ticket support, the conversation set the action variable to "search", and return a message in "A" that the system is searching for existing records. The web interface send back an empty message on behave of the user so the flow can continue.</p>
</li>
<li>
<p>If the conversation context has a variable action set to "search", it calls the corresponding backend to get other data. Like a ticket management app. We did not implement the ticket management app, but just a mockup.</p>
</li>
</ul>
<p><code>javascript
 if (req.body.context.action === "search" &amp;&amp; req.body.context.item ==="UserRequests") {
  ticketing.getUserTicket(config,req.body.user.email,function(ticket){
      if (config.debug) {
          console.log('Ticket response: ' + JSON.stringify(ticket));
      }
      req.body.context["Ticket"]=ticket
      sendToWCSAndBackToUser(config,req,res);
  })}</code>
 The ticket information is returned to the conversation directly and the message response is built there.
<em> if the action is "recommend", the code can call a decision service deployed on IBM Cloud and execute business rules to compute the best recommendations/ actions. See example of such approach in <a href="https://github.com/ibm-cloud-architecture/refarch-cognitive-prod-recommendations">the project "ODM and Watson conversation"</a>
</em> If in the conversation context the boolean <code>toneAnalyzer</code> is set to true, then any new sentence sent by the end user will be sent to Watson Tone Analyzer.</p>
<pre><code class="javascript">if (req.body.context.toneAnalyzer &amp;&amp; req.body.text !== &quot;&quot; ) {
    analyzeTone(config,req,res)
}
</code></pre>

<ul>
<li>When the result to the tone analyzer returns a tone as <code>Sad or Frustrated</code> then a call to a churn scoring service is performed.</li>
</ul>
<pre><code class="javascript">function analyzeTone(config,req,res){
  toneAnalyzer.analyzeSentence(config,req.body.text).then(function(toneArep) {
        if (config.debug) {console.log('Tone Analyzer '+ JSON.stringify(toneArep));}
        req.body.context[&quot;ToneAnalysisResponse&quot;]=toneArep.utterances_tone[0].tones[0];
        if (req.body.context[&quot;ToneAnalysisResponse&quot;].tone_name === &quot;Frustrated&quot;) {
          churnScoring.scoreCustomer(config,req,function(score){
                    req.body.context[&quot;ChurnScore&quot;]=score;
                    sendToWCSAndBackToUser(config,req,res);
              })
        }
  }).catch(function(error){
      console.error(error);
      res.status(500).send({'msg':error.Error});
    });
} // analyzeTone
</code></pre>

<ul>
<li>when the churn score is greater than a value the call is routed to a human. This is done in the conversation dialog and the context action is set to Transfer</li>
</ul>
<pre><code class="javascript">if (req.body.context.action === &quot;transfer&quot;) {
  console.log(&quot;Transfer to &quot;+ req.body.context.item)
}
</code></pre>

<p>See also how the IBM Watson conversation is built to support this logic, in <a href="../../wcs/">this note.</a></p>
<p>Finally this code can persist the conversation to a remote document oriented database. The code is in <code>persist.js</code> and a complete detailed explanation to setup this service is in <a href="../../persist/chattranscripts/">this note.</a></p>
<h3 id="customer-back-end">Customer back end</h3>
<p>The customer API is defined in the server/routes/feature folder and uses the request and hystrix libraries to perform the call to the customer micro service API. The <code>config.json</code> file specifies the end point URL.</p>
<p>The Hystrixjs is interesting to use to protect the remote call with timeout, circuit breaker, fails quickly.... modern pattern to support resiliency and fault tolerance.</p>
<pre><code class="javascript">var run = function(config,email){
  return new Promise(function(resolve, reject){
      var opts = buildOptions('GET','/customers/email/'+email,config);
      opts.headers['Content-Type']='multipart/form-data';
      request(opts,function (error, response, body) {
        if (error) {reject(error)}
        resolve(body);
      });
  });
}

// times out calls that take longer, than the configured threshold.
var serviceCommand =CommandsFactory.getOrCreate(&quot;getCustomerDetail&quot;)
  .run(run)
  .timeout(5000)
  .requestVolumeRejectionThreshold(2)
  .build();

getCustomerDetail : function(config,email) {
    return serviceCommand.execute(config,email);
}

</code></pre>

<h3 id="churn-risk-scoring">Churn risk scoring</h3>
<p>The scoring is done by deploying a trained model as a service. We have two clients, one for Watson Data Platform and one for Spark cluster on ICP.
The interface is the same so it is easy to change implementation.</p>
<h3 id="helm-chart">Helm chart</h3>
<p>We created a new helm chart for this application with
<code>helm create greencompute-telco-app</code>.
Then we update the following:
<em> Add a configMap.yaml file under the templates to defined the parameters used to configure the service end point metadata used by the BFF code.
</em> Add a volume in the deployment.yaml to use the parameters from the configMap. and mount this volume into the file. And modify the port mapping  </p>
<pre><code>spec:
  volumes:
    - name: config
      configMap:
        name:  {{ template &quot;greencompute-telco-app.fullname&quot; . }}
  containers:
    - name: {{ .Chart.Name }}
      image: &quot;{{ .Values.image.repository }}:{{ .Values.image.tag }}&quot;
      imagePullPolicy: {{ .Values.image.pullPolicy }}
      ports:
        - containerPort: {{ .Values.service.internalPort }}
      volumeMounts:
        - name: config
          mountPath: /greenapp/server/config/config.json
          subPath: config.json
</code></pre>

<ul>
<li>In values.yaml set the docker image name</li>
<li>Modify the value to use service.port to be externalPort and set it to match the one exposed in dockerfile:</li>
</ul>
<pre><code>service:
  type: ClusterIP
  externalPort: 3001
  internalPort: 3001
</code></pre>

<ul>
<li>enable ingress and set a hostname (telcoapp.green.case)</li>
<li>In the ingress use the servicePort to map the externalPort.</li>
</ul>
<pre><code>{{- $servicePort := .Values.service.externalPort -}}
</code></pre>

<ul>
<li>In the service.yaml be sure to define the ports well using the one set in values.yaml</li>
</ul>
<pre><code>ports:
  - port: {{ .Values.service.externalPort }}
    targetPort: {{ .Values.service.internalPort }}
    protocol: TCP
    name: {{ .Values.service.name }}
</code></pre>

<h3 id="icp-deployment">ICP deployment</h3>
<p>For this web application we are following the same steps introduced within the <a href="https://github.com/ibm-cloud-architecture/refarch-caseportal-app/blob/master/docs/icp/README.md">Brown Case Web app application</a> and can be summarized as:
<em> Compile the app: <code>ng build</code>
</em> Create docker images: <code>docker build -t ibmcase/greencompute-telco-app  .</code>
<em> We are now using public dockerhub so just we are doing a <code>docker push ibmcase/greencompute-telco-app</code>
</em> When deploying to a private registry as the one internal to ICP, tag the image with the docker repository name, version: <code>docker tag ibmcase/greencompute-telco-app  greencluster.icp:8500/greencompute/greencompute-telco-app</code>, then push the docker images to the docker repository running on the Master node of ICP:</p>
<pre><code>$ docker login greencluster.icp:8500
$ docker push greencluster.icp:8500/greencompute/greenapp:v0.0.2
</code></pre>

<ul>
<li>Be sure to be connected to the kubernetes server with commands like:</li>
</ul>
<pre><code>bx pr login -u admin -a https://greencluster.icp:8443 --skip-ssl-validation
bx pr cluster-config greencluster.icp
</code></pre>

<ul>
<li>Install the Helm release with the greencompute namespace: <code>helm install  greencompute-telco-app/ --name green-telco-app --namespace greencompute</code></li>
</ul>
<p><img alt="" src="greenapp-deployed.png" /></p>
<ul>
<li>
<p>Be sure you have name resolution from the hostname you set in values.yaml and IP address of the ICP proxy. Use your local '/etc/hosts' file for that. In production, set your local DNS with this name resolution.</p>
</li>
<li>
<p>Test by accessing the URL: <code>http://http://greenapp.green.case/</code></p>
</li>
</ul>
<h2 id="customer-microservice">Customer Microservice</h2>
<p>The back end customer management function is a micro service in its separate repository, and the code implementation explanation can be read <a href="https://github.com/ibm-cloud-architecture/refarch-integration-services#code-explanation">here.</a></p>
<h2 id="more-readings">More readings</h2>
<ul>
<li><a href="https://angular.io/">Angular io</a></li>
<li><a href="https://www.npmjs.com/package/hystrixjs">Hystrixjs the latency an fault tolerance library</a></li>
<li>Javascript Promise chaining <a href="https://javascript.info/promise-chaining">article</a></li>
<li>[Case Portal app using Angular 5 app using a test driven development approach in <a href="https://github.com/ibm-cloud-architecture/refarch-caseportal-app">this project</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../readme/" title="Design considerations" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Design considerations
              </span>
            </div>
          </a>
        
        
          <a href="../../run/" title="Deployments" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Deployments
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>